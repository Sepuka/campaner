version: v1.0
name: Go
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: warming cache
    task:
      prologue:
        commands:
          - export GOPATH=$HOME/go
          - export PATH=$(go env GOPATH)/bin:$PATH
          - export "SEMAPHORE_GIT_DIR=$(go env GOPATH)/src/github.com/${SEMAPHORE_PROJECT_NAME}"
          - mkdir -p "${SEMAPHORE_GIT_DIR}" "$(go env GOPATH)/bin"
      jobs:
      - name: fetch code and dependencies
        commands:
          - checkout
          - make dependencies
          - cache store deps-$SEMAPHORE_GIT_BRANCH-$(checksum Gopkg.lock) vendor
  - name: Tests
    task:
      prologue:
        commands:
          - export GOPATH=$HOME/go
          - export PATH=$(go env GOPATH)/bin:$PATH
          - export "SEMAPHORE_GIT_DIR=$(go env GOPATH)/src/github.com/${SEMAPHORE_PROJECT_NAME}"
          - mkdir -p "${SEMAPHORE_GIT_DIR}" "$(go env GOPATH)/bin"
          - export GO111MODULE=on
      jobs:
        - name: go test
          commands:
            - checkout
            - make dependencies
            - cache restore deps-$SEMAPHORE_GIT_BRANCH-$(checksum Gopkg.lock),deps-$SEMAPHORE_GIT_BRANCH,deps-master
            - make tests
